# DevOps Assignment Report

**Student Name**: [Your Name]  
**Date**: November 29, 2025  
**Course**: BCSAI SDDO 2025 — IE University

---

## Project Overview

This project is a note-taking application deployed on **Azure Container Apps (ACA)** using **Azure Container Registry (ACR)** for image hosting. The infrastructure is fully automated via **Terraform** and **GitHub Actions** for CI/CD.

### Architecture

- **Frontend**: React application served via NGINX (`frontend-notetakingapp`)
- **Backend**: Django REST API (`backend-notetakingapp`)
- **Worker**: Celery worker for async tasks (`worker-notetakingapp`)
- **Database**: Azure Database for PostgreSQL Flexible Server (managed)
- **Cache/Queue**: Azure Cache for Redis (managed)

All three container apps share a **user-assigned managed identity** with `AcrPull` role for pulling images from ACR.

---

## CI/CD Pipeline

### Continuous Integration (CI)
**Workflow**: `.github/workflows/ci.yml`

1. **Checkout code** and set up Python 3.11
2. **Install dependencies** from `backend/requirements-dev.txt`
3. **Run tests** with pytest:
   - Unit tests and integration tests
   - Generate coverage reports (HTML, XML, JUnit XML)
   - Enforce **≥70% code coverage**
4. **Build Docker images** for frontend, backend, and worker
5. **Push images to ACR** tagged with commit SHA

**Trigger**: Push to `main` branch or pull requests

### Continuous Deployment (CD)
**Workflow**: `.github/workflows/cd.yml`

1. **Triggered** after successful CI run (via `workflow_run`) or manual dispatch
2. **Authenticate** with Azure using `AZURE_CREDENTIALS` service principal
3. **Run Terraform** in `terraform/azure/`:
   - Initialize backend (Azure Blob Storage for state)
   - Plan infrastructure changes
   - Apply changes to provision:
     - PostgreSQL Flexible Server
     - Azure Cache for Redis
     - Container Apps Environment (with Log Analytics)
     - Three Container Apps with secrets and environment variables
4. **Output** frontend and backend URLs

**Trigger**: CI success or manual workflow dispatch

---

## Infrastructure as Code (Terraform)

### Modules

1. **identities**: Creates a shared user-assigned managed identity
2. **role_assignments**: Grants `AcrPull` role to the identity on existing ACR
3. **containerapps_env**: Provisions Log Analytics workspace and Container Apps Environment
4. **postgres**: Creates PostgreSQL Flexible Server with random password
5. **redis**: Creates Azure Cache for Redis with TLS enabled
6. **containerapp**: Reusable module for creating Container Apps with:
   - Container configuration (image, resources, env vars)
   - Secrets management (DB/Redis credentials)
   - Ingress configuration (external/internal)

### State Management
- **Backend**: Azure Blob Storage
- **Configuration**: `TF_STATE_RG`, `TF_STATE_ACCOUNT`, `TF_STATE_CONTAINER`, `TF_STATE_KEY`

---

## Testing & Coverage

### Running Tests Locally

From the repository root:

```bash
# Create and activate virtual environment
python -m venv .venv
source .venv/bin/activate

# Install dependencies
pip install -r backend/requirements-dev.txt

# Set Python path
export PYTHONPATH="${PWD}/backend:${PYTHONPATH}"

# Run tests with coverage
pytest tests \
  --cov=core \
  --cov-report=html:reports/htmlcov \
  --cov-report=xml:reports/coverage.xml \
  --junitxml=reports/junit.xml \
  --cov-fail-under=70 -v
```

### Test Results

- **Total Tests**: [Add your count]
- **Passed**: [Add your count]
- **Coverage**: [Add your %]
- **Coverage Report**: `reports/htmlcov/index.html`

### Test Structure

```
tests/
├── conftest.py           # Shared fixtures
└── core/
    ├── test_core.py      # Core model tests
    ├── test_parsers.py   # Parser unit tests
    ├── test_services_tasks.py  # Service/task tests
    └── test_views_extra.py     # API endpoint tests
```

---

## Security & Secrets Management

### GitHub Secrets
- `AZURE_CREDENTIALS`: Service principal JSON (for CI/CD authentication)
- `DJANGO_SECRET_KEY`: Django application secret
- `GOOGLE_API_KEY`: External API key
- `PINECONE_API_KEY`: Vector database API key

### Repository Variables
- `ACR_LOGIN_SERVER`: ACR hostname
- `TF_STATE_RG`, `TF_STATE_ACCOUNT`, `TF_STATE_CONTAINER`, `TF_STATE_KEY`: Terraform backend config

### Container App Secrets
Database and Redis credentials are:
- Generated by Terraform (random passwords)
- Stored as Container App secrets
- Referenced via `secretRef` in environment variables
- Never exposed in GitHub or version control

---

## Monitoring & Observability

### Health Checks
- Backend exposes `/health` endpoint for liveness/readiness probes
- Container Apps configured with health probe paths

### Logging
- **Azure Log Analytics**: Centralized logging for all Container Apps
- **Container App logs**: Accessible via Azure Portal and CLI

### Metrics (Planned)
- Prometheus exposition at `/metrics` endpoint (basic implementation)
- Can be extended with Grafana dashboards for visualization

---

## Deployment Process

### Prerequisites
1. Azure subscription with resource group `BCSAI2025-DEVOPS-STUDENTS-A`
2. Azure Container Registry created via Portal
3. Service Principal with:
   - `Contributor` role on resource group
   - `AcrPush` role on ACR
   - `Storage Blob Data Contributor` on state storage account
4. GitHub repository secrets and variables configured

### Deployment Steps

1. **Push code to main branch**
   - Triggers CI workflow
   - Runs tests and builds images
   - Pushes images to ACR

2. **CD workflow automatically triggered**
   - Runs Terraform to provision/update infrastructure
   - Deploys Container Apps with latest images

3. **Verify deployment**
   - Check workflow logs in GitHub Actions
   - Access frontend URL (output by Terraform)
   - Test backend API endpoints
   - Verify Celery worker is processing tasks

---

## Challenges & Solutions

### Challenge 1: ACR Authentication
**Problem**: Container Apps needed to pull images from private ACR  
**Solution**: Created user-assigned managed identity with `AcrPull` role assignment

### Challenge 2: Database SSL Connection
**Problem**: Azure PostgreSQL requires SSL by default  
**Solution**: Added `PGSSLMODE=require` environment variable and optional SSL settings in Django

### Challenge 3: Terraform State Management
**Problem**: Empty `TF_STATE_KEY` caused backend initialization to fail  
**Solution**: Set `TF_STATE_KEY` to non-empty value (e.g., `note-taking-app.terraform.tfstate`)

### Challenge 4: Environment Variables in CI
**Problem**: Django needed `.env` file for tests  
**Solution**: Reconstructed `.env` from individual GitHub secrets in CI workflow

---

## Future Improvements

1. **Scaling**: Implement autoscaling rules based on HTTP traffic or CPU usage
2. **Networking**: Add Virtual Network integration and private endpoints
3. **Monitoring**: Full Prometheus + Grafana setup with custom dashboards
4. **Security**: Implement Azure Key Vault for secrets management
5. **Performance**: Add Azure CDN for frontend static assets
6. **CI/CD**: Add staging environment and blue-green deployment strategy

---

## Conclusion

This project demonstrates a complete DevOps pipeline for a containerized application on Azure. The infrastructure is fully automated, reproducible, and follows cloud-native best practices. The CI/CD pipeline ensures code quality through automated testing and enables rapid, safe deployments.

---

## Appendix

### Useful Commands

```bash
# View Container App logs
az containerapp logs show \
  --name backend-notetakingapp \
  --resource-group BCSAI2025-DEVOPS-STUDENTS-A \
  --follow

# Manually trigger CD workflow
gh workflow run cd.yml -f sha=$(git rev-parse HEAD)

# Check Terraform plan locally
cd terraform/azure
terraform init -reconfigure \
  -backend-config="resource_group_name=${TF_STATE_RG}" \
  -backend-config="storage_account_name=${TF_STATE_ACCOUNT}" \
  -backend-config="container_name=${TF_STATE_CONTAINER}" \
  -backend-config="key=${TF_STATE_KEY}"
terraform plan

# Access PostgreSQL
az postgres flexible-server execute \
  --name <server-name> \
  --admin-user <username> \
  --admin-password <password> \
  --database-name <db-name> \
  --querytext "SELECT version();"
```

### References
- [Azure Container Apps Documentation](https://learn.microsoft.com/azure/container-apps/)
- [Azure Database for PostgreSQL](https://learn.microsoft.com/azure/postgresql/)
- [Azure Cache for Redis](https://learn.microsoft.com/azure/azure-cache-for-redis/)
- [Terraform AzureRM Provider](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)
